# V2 Refactoring Plan & Revision Record

## 1) Refactoring Purpose Context

This V2 refactor preserves the original system context (market-scoped, event-driven, bias-safe backtesting) and addresses new team-organization requirements:

- Team structure is now first-class:
  - Portfolio Optimization Team
  - Trading Strategy Team
  - Arbitrage Team
- Strategy and backtesting are separated so teammates can change only strategy logic while using the correct backtest engine automatically.
- Backtesting entrypoints are split by team:
  - Portfolio Backtest
  - Trading Backtest
  - Arbitrage Backtest
- Program stability planning includes package/API compatibility hardening and contract validation.

## 2) What Changed (V2)

### A. Team-aware domain model
- Added `TeamType` enum (`portfolio`, `trading`, `arbitrage`) to shared models.
- Added team-scoped strategy contract module `shared/strategy_contracts.py` with typed outputs for portfolio/arbitrage evolution.

### B. Strategy loader contract validation
- `services/signal_gen/strategy_loader.py` now validates optional strategy team contract at load time.
- `get_strategy()` supports `expected_team` routing and cache keys include team.
- Existing strategy compatibility is preserved by defaulting to `trading` team if undeclared.

### C. Signal engine carries team context
- `services/signal_gen/engine.py` now accepts `team` and loads strategies with expected team validation.
- Backtest sync execution and live/paper strategy loading use the same team-aware contract path.

### D. Backtesting architecture separation (team-based)
- Added `backtest/engines/` package with:
  - `portfolio_engine.py` (`PortfolioBacktestEngine`)
  - `trading_engine.py` (exports current core engine)
  - `arbitrage_engine.py` (`ArbitrageBacktestEngine`)
- Added `backtest/engine_router.py` to route engine class by `TeamType`.
- Existing `backtest/engine.py` remains functional and is now the trading-core baseline (backward compatibility preserved).

### E. CLI routing and usability
- `scripts/run_backtest.py` now supports `--team {portfolio,trading,arbitrage}` for both `backtest` and `walkforward`.
- Backtest engine is selected automatically via router using team value.
- Console report now includes team in output.

### F. Walk-forward support updated
- `backtest/walk_forward.py` now includes team in config and resolves team-specific engines when executing windows.

### G. Strategy declaration example updated
- `strategies/turtle_breakout.py` now declares `TEAM_TYPE = TeamType.TRADING` as canonical pattern for strategy-team matching.

## 3) Compatibility & Migration Notes

- Existing workflows without explicit `team` continue to work due to default team fallback (`trading`).
- Existing trading strategies remain loadable.
- Team-specific engines for portfolio and arbitrage currently reuse core execution path as a safe baseline, while exposing isolated extension points for future basket/leg fill semantics.

## 4) How to Use V2

### Run trading-team backtest (default behavior)
```bash
python scripts/run_backtest.py backtest \
  --team trading \
  --strategy turtle_breakout \
  --market crypto \
  --symbols BTCUSDT \
  --start 2022-01-01 \
  --end 2023-01-01
```

### Run portfolio-team backtest
```bash
python scripts/run_backtest.py backtest \
  --team portfolio \
  --strategy turtle_breakout \
  --market us \
  --symbols AAPL,MSFT,GOOGL \
  --start 2022-01-01 \
  --end 2023-01-01
```

### Run arbitrage-team walk-forward
```bash
python scripts/run_backtest.py walkforward \
  --team arbitrage \
  --strategy turtle_breakout \
  --market crypto \
  --symbols BTCUSDT,ETHUSDT \
  --start 2022-01-01 \
  --end 2023-01-01
```

## 5) Next hardening scope (planned)

1. Implement true portfolio rebalance execution semantics in `PortfolioBacktestEngine`.
2. Implement multi-leg synchronization and fail policies in `ArbitrageBacktestEngine`.
3. Add dependency compatibility checker script and stricter package pinning.
4. Add CI regression suites by team for deterministic replay.
